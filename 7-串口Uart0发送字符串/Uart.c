/*
 *  2020å¹´10æœˆ29æ—¥ 16ç‚¹24åˆ† â˜†4
 * 
 *  ä¸²å£é€šè®¯å®éªŒ2 â€”â€” ä½¿ç”¨å®šæ—¶å™¨ 2 äº§ç”Ÿä¸²å£æ—¶é’Ÿ
 *  
 *  æˆ‘é¦–å…ˆè¯•éªŒè¿‡ä¸²å£æ¨¡å¼ 0ï¼Œå‡ ä¹éƒ½å·²å¤±è´¥å‘Šç»ˆï¼Œç”±äºæ²¡æœ‰ä¾‹ç¨‹ï¼Œä¹Ÿæ— æ³•æ£€æŸ¥å‡ºé”™è¯¯çš„æ ¹æºã€‚
 *  ä½¿ç”¨å®šæ—¶å™¨ T1 é©±åŠ¨ä¸²å£æ—¶å‘ç°è®¡æ•°å‘¨æœŸçŸ­äº†ï¼Œå‡ ä¹æ— æ³•ç”Ÿæˆä½æ³¢ç‰¹ç‡çš„æ—¶é’Ÿã€‚
 *  è€Œå®šæ—¶å™¨ T2 æ˜¯ä¸€ä¸ªè‡ªåŠ¨é‡è½½çš„å®šæ—¶å™¨ï¼Œéå¸¸é€‚åˆç”¨ä½œ ä¸²å£Uart0 çš„æ—¶é’Ÿã€‚
 * 
 * 
 *  å®éªŒç»“æœï¼Œ20ç‚¹01åˆ† ç»ˆäºæŠ˜è…¾å®Œäº†ï¼Œ
 *  è™½ç„¶è·ç¦»å®ç”¨çš„ç¨‹åºè¿˜æœ‰äº›å·®è·ï¼Œä½†æ˜¯åŸºæœ¬å®ç°äº†å­—ç¬¦ä¸²å‘é€é—®é¢˜ã€‚ğŸ˜« å¥½ç´¯å•Šã€‚ã€‚ã€‚
 *  1200bps ä¸‹æ²¡æœ‰é—®é¢˜ï¼Œå…¶ä»–æ³¢ç‰¹ç‡æ²¡æœ‰æµ‹è¯•ã€‚ã€‚ã€‚
 *  
**/

#include"CH559.H"
#include<intrins.h>

// è¿™æ˜¯ä¸€ä¸ªè®¡ç®—å…¬å¼ï¼Œä½†å…¶ä¸­çš„é™¤ä»¥ 16 æ˜¯ä»€ä¹ˆåŸå› æˆ‘è¿˜æ²¡å¼„æ˜ç™½ ğŸ¤·â€
// 65535 = 0xFFFF æ˜¯ 16 ä½è®¡æ•°å™¨çš„æœ€å¤§è®¡æ•°å€¼
// 12000000 = 12M æ˜¯æ™¶æŒ¯é¢‘ç‡
// 9200 æ˜¯æˆ‘è®¾ç½®çš„ æ³¢ç‰¹ç‡(bps)
// ä¸ºä»€ä¹ˆè¦é™¤ä»¥â—16å‘¢ï¼Ÿï¼Ÿï¼Ÿ
unsigned int code baud = 65535 - 12000000/4/16/1200;

void timer2_config(void){

  TH2       = (baud & 0xFF00) >> 8;
  TL2       = baud & 0x00FF;
  RCAP2H    = (baud & 0xFF00) >> 8;
  RCAP2L    = baud & 0x00FF;

  RCLK      = 1;   // é€‰æ‹© Timer2 äº§ç”Ÿæ—¶é’Ÿ
  TCLK      = 1;

  C_T2      = 0;  // ä½¿ç”¨å†…éƒ¨æ—¶é’Ÿ
  CP_RL2    = 0;  // ç”¨ä½œå®šæ—¶è€Œéè®¡æ•°

  TR2 = 1;        // å¯åŠ¨å®šæ—¶å™¨ T2

//  bTMR_CLK = 0;
//  bT2_CLK  = 0;

}

void uart0_config(void){
  SM0 = 0;
  SM1 = 1;
  SM2 = 1;

  REN = 1;
}

void interrupt_config(void){

  EA = 1;
  E_DIS = 0;
  ES = 1;

}

unsigned char i = 0;
unsigned char txd_dat[64] = "ABCDEFG,HIJKLMN,OPQRST,UVWXYZ\n";
unsigned char send_enable = 0;
void main(void){

  interrupt_config();
  uart0_config();
  timer2_config();
  send_enable = 1;
  TI = 1;
  while(1);

}

void uart0_interrupt(void) interrupt 4 {

	if(TI){
    if(send_enable){
      if(txd_dat[i]!=NULL){
        SBUF = txd_dat[i];
        i++;
      }else{
        i = 0;
        send_enable = 0;
      }

    }
		  TI = 0;
  }
  
  if(RI){
    RI = 0;
  }

}
